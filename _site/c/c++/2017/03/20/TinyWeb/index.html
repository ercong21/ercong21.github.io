<!DOCTYPE html>
<html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <title>Tiny Web 服务器源码学习 &mdash; Ercong Nie [ɚ'tsʰʊŋ, niɛ]</title>
    <link rel="stylesheet" href="http://localhost:4000/assets/vendor/primer-css/css/primer.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/vendor/primer-markdown/dist/user-content.min.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/vendor/octicons/octicons/octicons.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/components/collection.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/components/repo-card.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/sections/repo-list.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/sections/mini-repo-list.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/sections/profile.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/sections/contact.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/sections/news.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/components/boxed-group.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/globals/common.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/vendor/share.js/dist/css/share.min.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/globals/responsive.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/posts/index.css">
    <!-- Latest compiled and minified CSS -->
    

    
    <link rel="canonical" href="http://localhost:4000/c/c++/2017/03/20/TinyWeb/">
    <link rel="alternate" type="application/atom+xml" title="Ercong Nie [ɚ'tsʰʊŋ, niɛ]" href="/feed.xml">
    <link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
    
    <meta property="og:title" content="Tiny Web 服务器源码学习">
      
    <meta name="keywords" content="C, Tiny Web, 源码阅读">
    <meta name="og:keywords" content="C, Tiny Web, 源码阅读">
      
    <meta name="description" content="Tiny Web服务器是《深入理解计算机系统》一书中11.6节的内容，该节演示了一个只有250行代码的服务器，非常适合对C语言和网络编程感兴趣的朋友进行学习！话不多说，让我们开始正式的学习！">
    <meta name="og:description" content="Tiny Web服务器是《深入理解计算机系统》一书中11.6节的内容，该节演示了一个只有250行代码的服务器，非常适合对C语言和网络编程感兴趣的朋友进行学习！话不多说，让我们开始正式的学习！">
      
    
    
        
    
    <meta property="og:url" content="http://localhost:4000/c/c++/2017/03/20/TinyWeb/">
    <meta property="og:site_name" content="Ercong Nie [ɚ'tsʰʊŋ, niɛ]">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="zh_CN" />
    
    <meta property="article:published_time" content="2017-03-20">
    
    <script src="http://localhost:4000/assets/vendor/jquery/dist/jquery.min.js"></script>
    <script src="http://localhost:4000/assets/js/jquery-ui.js"></script>
    <script type="text/javascript">
    function toggleMenu() {
        var nav = document.getElementsByClassName("site-header-nav")[0];
        if (nav.style.display == "inline-flex") {
          nav.style.display = "none";
        } else {
          nav.style.display = "inline-flex";
        }
    }
    </script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-114643083-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-114643083-1');
    </script>
</head>
<body class="" data-mz="">
    <header class="site-header">
        <div class="container">
            <h1><a href="http://localhost:4000/" title="Ercong Nie [ɚ'tsʰʊŋ, niɛ]">Ercong Nie [ɚ'tsʰʊŋ, niɛ]</a></h1>
            <button class="collapsed mobile-visible" type="button" onclick="toggleMenu();">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <nav class="site-header-nav" role="navigation">
                
                <a href="http://localhost:4000/" class=" site-header-nav-item" target="" title="Home">Home</a>
                
                <a href="http://localhost:4000/news/" class=" site-header-nav-item" target="" title="News">News</a>
                
                <a href="http://localhost:4000/publications/" class=" site-header-nav-item" target="" title="Publications">Publications</a>
                
                <a href="http://localhost:4000/teaching/" class=" site-header-nav-item" target="" title="Teaching">Teaching</a>
                
                <a href="http://localhost:4000/grants/" class=" site-header-nav-item" target="" title="Grants">Grants</a>
                
                <a href="http://localhost:4000/files/Resume_Nie.pdf" class=" site-header-nav-item" target="" title="CV">CV</a>
                
            </nav>
        </div>
    </header>
    <!-- / header -->

    <section class="collection-head small geopattern" data-pattern-id="Tiny Web 服务器源码学">
<div class="container">
  <div class="columns">
    <div class="column three-fourths">
      <div class="collection-title">
        <h1 class="collection-header">Tiny Web 服务器源码学习</h1>
        <div class="collection-info">
          
          <span class="meta-info">
            <span class="octicon octicon-calendar"></span> 2017/03/20
          </span>
          
          
          <span class="meta-info">
            <span class="octicon octicon-file-directory"></span>
            <a href="http://localhost:4000/categories/#C/C++" title="C/C++">C/C++</a>
          </span>
          
        </div>
      </div>
    </div>
  </div>
</div>
</section>
<!-- / .banner -->
<section class="container content">
<div class="columns">
  <div class="column three-fourths" >
    <article class="article-content markdown-body">
    <p>Tiny Web服务器是《深入理解计算机系统》一书中11.6节的内容，该节演示了一个只有250行代码的服务器，非常适合对C语言和网络编程感兴趣的朋友进行学习！话不多说，让我们开始正式的学习！</p>

<h3 id="基本使用">基本使用</h3>

<p>Tiny Web服务器的主要代码在原书上已经给出，如果要下载完整的代码，可以在官网上进行下载，具体地址请点击<a href="http://csapp.cs.cmu.edu/3e/tiny.rar">这里</a>，除此之外，在Github上也可以搜到热心用户上传的代码。</p>

<p>下载好代码之后，我们要进行编译才可以使用。如果是官网代码的话，直接使用<code class="language-plaintext highlighter-rouge">make</code>命令进行编译就可以了，如果不是的话（没有Makefile文件），则具体编译操作如下：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcc tiny.c csapp.c <span class="nt">-o</span> tiny 
<span class="nb">cd </span>cgi-bin
gcc adder.c <span class="nt">-o</span> adder <span class="nt">-I</span>../
<span class="nb">cd</span> ..
</code></pre></div></div>

<p>编译完成后，我们只要执行<code class="language-plaintext highlighter-rouge">./tiny 8888</code>，就可以开启Tiny Web服务器了！</p>

<p>首先输入127.0.0.1:8888，可以对Tiny Web服务器的静态页面进行测试，然后输入127.0.0.1:8888/cgi-bin/adder?1&amp;2，可以对服务器的动态页面进行测试。这里值得一提的是，Tiny Web服务器只支持GET请求，如果是POST请求的话，会返回错误信息。</p>

<h3 id="源码解读">源码解读</h3>

<h4 id="套接字接口">套接字接口</h4>

<p>套接字接口（socket interface）是一组函数，它们和Unix I/O函数结合起来，用以创建网络应用。学习socket编程能够让我们加深对网络框架的理解，socket编程的函数可以通过下图体现：</p>

<p><img src="/images/posts/c/tinyweb-socket.png" alt="套接字接口概述" /></p>

<p>通过此图，我们可以大致了解socket包含哪些函数，接下来我们对几个重要的函数进行一一介绍：</p>

<p><strong>socket函数</strong></p>

<p>客户端和服务器使用socket函数来创建一个套接字描述符，具体使用如下：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span><span class="kt">int</span> <span class="nf">socket</span><span class="p">(</span><span class="kt">int</span> <span class="n">domain</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">);</span>
</code></pre></div></div>

<p>其中，domain指定socket的通信协议集（AF_UNIX和AF_INET等），AF_UNIX只能用于单一的*nix系统，而AF_INET是用于网络的，所以可以允许远程主机之间的通信；type指定socket类型（SOCK_STREAM和SOCK_DGRAM等），SOCK_STREAM表明使用TCP协议，SOCK_DGRAM表明使用UDP协议；protocol指定实际使用的传输协议，如果该项为0，则使用缺省协议。调用socket函数后，成功会返回文件描述符，失败返回-1。</p>

<p><strong>bind函数</strong></p>

<p>bind函数是服务器特有的函数，其使用如下：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span><span class="kt">int</span> <span class="nf">bind</span><span class="p">(</span><span class="kt">int</span> <span class="n">socket</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">address</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="n">address_len</span><span class="p">);</span>
</code></pre></div></div>

<p>bind函数为socket分配地址，其中socket是套接字描述符，address指向sockaddr结构（用于表示所分配地址）的指针，address_len是sockaddr结构的长度。</p>

<p><strong>listen函数</strong></p>

<p>listen函数将sockfd从一个主动套接字转化为一个监听套接字，该套接字可以接受来自客户端的连接请求，具体使用如下：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span><span class="kt">int</span> <span class="nf">listen</span><span class="p">(</span><span class="kt">int</span> <span class="n">socket</span><span class="p">,</span> <span class="kt">int</span> <span class="n">backlog</span><span class="p">);</span>
</code></pre></div></div>

<p>其中backlog是一个决定监听队列大小的整数，当有连接请求到来，就会进入此监听队列，当队列满后，新的连接请求会返回错误。</p>

<p><strong>accept函数</strong></p>

<p>服务器通过调用accept函数来等待来自客户端的连接请求，具体使用如下：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span><span class="kt">int</span> <span class="nf">accept</span><span class="p">(</span><span class="kt">int</span> <span class="n">socket</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="kr">restrict</span> <span class="n">address</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="o">*</span><span class="kr">restrict</span> <span class="n">address_len</span><span class="p">);</span>
</code></pre></div></div>

<p>其中socket是监听的socket描述符，address是指向sockaddr结构体的指针，address_len是客户机地址结构体的大小。</p>

<p><strong>connect函数</strong></p>

<p>客户端通过调用connect函数来建立与服务器的连接，具体使用如下：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span><span class="kt">int</span> <span class="nf">connect</span><span class="p">(</span><span class="kt">int</span> <span class="n">socket</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">address</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="n">address_len</span><span class="p">);</span>
</code></pre></div></div>

<p><strong>socket类型</strong></p>

<p>socket类型主要有SOCK_STREAM、SOCK_DGRAM、SOCK_RAW三种，其中SOCK_RAW工作在网络层，可以处理ICMP、IGMP等网络报文以及特殊的IPv4报文，而SOCK_STREAM(TCP)、SOCK_DGRAM(UDP)工作在传输层。</p>

<h4 id="csappc的open_clientfd函数">csapp.c的open_clientfd函数</h4>

<p><strong>具体代码</strong></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
 * open_clientfd - Open connection to server at &lt;hostname, port&gt; and
 *     return a socket descriptor ready for reading and writing. This
 *     function is reentrant and protocol-independent.
 * 
 *     On error, returns -1 and sets errno.
 */</span>
<span class="kt">int</span> <span class="nf">open_clientfd</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">hostname</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">clientfd</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">addrinfo</span> <span class="n">hints</span><span class="p">,</span> <span class="o">*</span><span class="n">listp</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

    <span class="cm">/* Get a list of potential server addresses */</span>
    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">addrinfo</span><span class="p">));</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_socktype</span> <span class="o">=</span> <span class="n">SOCK_STREAM</span><span class="p">;</span>  <span class="cm">/* Open a connection */</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_flags</span> <span class="o">=</span> <span class="n">AI_NUMERICSERV</span><span class="p">;</span>  <span class="cm">/* ... using a numeric port arg. */</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_flags</span> <span class="o">|=</span> <span class="n">AI_ADDRCONFIG</span><span class="p">;</span>  <span class="cm">/* Recommended for connections */</span>
    <span class="n">Getaddrinfo</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">listp</span><span class="p">);</span>
  
    <span class="cm">/* Walk the list for one that we can successfully connect to */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">listp</span><span class="p">;</span> <span class="n">p</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ai_next</span><span class="p">)</span> <span class="p">{</span>

        <span class="cm">/* Create the socket descriptor */</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">clientfd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ai_family</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ai_socktype</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ai_protocol</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> 
            <span class="k">continue</span><span class="p">;</span> <span class="cm">/* Socket failed, try the next */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">connect</span><span class="p">(</span><span class="n">clientfd</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ai_addr</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ai_addrlen</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
            <span class="k">break</span><span class="p">;</span> <span class="cm">/* Success */</span>
        <span class="n">Close</span><span class="p">(</span><span class="n">clientfd</span><span class="p">);</span> <span class="cm">/* Connect failed, try another */</span>
    <span class="p">}</span> 

    <span class="cm">/* Clean up */</span>
    <span class="n">Freeaddrinfo</span><span class="p">(</span><span class="n">listp</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="cm">/* All connects failed */</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">else</span>    <span class="cm">/* The last connect succeeded */</span>
        <span class="k">return</span> <span class="n">clientfd</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>详细解析</strong></p>

<ul>
  <li>将socket和connect函数包装成一个叫做open_clientfd的辅助函数是很方便的，客户端可以用它来和服务器建立连接</li>
  <li>函数中需要使用到结构体addrinfo，这是头文件netdb.h中带有的结构体，netdb.h提供了设置及获取域名的函数</li>
  <li>函数先为结构体addrinfo变量hints动态分配内存空间，然后设置结构体成员的值，这里的“|=”运算符是表示或运算</li>
  <li>配置好hints后，open_clientfd函数将调用Getaddrinfo函数（用于通过域名获取IP）返回一个指向addrinfo结构体链表的指针，这个指针也就是listp</li>
  <li>接下来函数将遍历listp。每次遍历都是先调用socket函数，如果获取套接字描述符失败，则会执行下一次遍历，如果成功，则会尝试连接。如果连接成功，则会跳出循环，如果失败，则继续尝试</li>
  <li>结束遍历后，函数会释放listp占有的内存，并且判断是否获取到能够连接的socket，如果获取到直接返回，反之则返回-1</li>
</ul>

<h4 id="csappc的open_listenfd函数">csapp.c的open_listenfd函数</h4>

<p><strong>具体代码</strong></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
 * open_listenfd - Open and return a listening socket on port. This
 *     function is reentrant and protocol-independent.
 *
 *     On error, returns -1 and sets errno.
 */</span>
<span class="kt">int</span> <span class="nf">open_listenfd</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span> 
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">addrinfo</span> <span class="n">hints</span><span class="p">,</span> <span class="o">*</span><span class="n">listp</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">listenfd</span><span class="p">,</span> <span class="n">optval</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>

    <span class="cm">/* Get a list of potential server addresses */</span>
    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">addrinfo</span><span class="p">));</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_socktype</span> <span class="o">=</span> <span class="n">SOCK_STREAM</span><span class="p">;</span>  <span class="cm">/* Accept TCP connections */</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_flags</span> <span class="o">=</span> <span class="n">AI_PASSIVE</span><span class="p">;</span>      <span class="cm">/* ... on any IP address */</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_flags</span> <span class="o">|=</span> <span class="n">AI_NUMERICSERV</span><span class="p">;</span> <span class="cm">/* ... using a numeric port arg. */</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_flags</span> <span class="o">|=</span> <span class="n">AI_ADDRCONFIG</span><span class="p">;</span>  <span class="cm">/* Recommended for connections */</span>
    <span class="n">Getaddrinfo</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">listp</span><span class="p">);</span>

    <span class="cm">/* Walk the list for one that we can bind to */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">listp</span><span class="p">;</span> <span class="n">p</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ai_next</span><span class="p">)</span> <span class="p">{</span>

        <span class="cm">/* Create a socket descriptor */</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">listenfd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ai_family</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ai_socktype</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ai_protocol</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> 
            <span class="k">continue</span><span class="p">;</span>  <span class="cm">/* Socket failed, try the next */</span>

        <span class="cm">/* Eliminates "Address already in use" error from bind */</span>
        <span class="n">Setsockopt</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,</span> <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_REUSEADDR</span><span class="p">,</span> 
                   <span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">optval</span> <span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>

        <span class="cm">/* Bind the descriptor to the address */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ai_addr</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ai_addrlen</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span> <span class="cm">/* Success */</span>
        <span class="n">Close</span><span class="p">(</span><span class="n">listenfd</span><span class="p">);</span> <span class="cm">/* Bind failed, try the next */</span>
    <span class="p">}</span>

    <span class="cm">/* Clean up */</span>
    <span class="n">Freeaddrinfo</span><span class="p">(</span><span class="n">listp</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="cm">/* No address worked */</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

    <span class="cm">/* Make it a listening socket ready to accept connection requests */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">listen</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,</span> <span class="n">LISTENQ</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">listenfd</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>详细解析</strong></p>

<ul>
  <li>将socket、bind和listen函数包装成一个叫做open_listenfd的辅助函数是很方便的，服务端可以用它来创建一个监听描述符</li>
  <li>open_listenfd函数用与open_clientfd函数类似的方法获取到可能的地址列表listp</li>
  <li>然后遍历listp。每次遍历都是先调用socket函数，如果获取套接字描述符失败，则会执行下一次遍历，反之则进行套接字设置。设置完套接字后，则尝试绑定描述符，如果成功，则会跳出循环，如果失败，则继续尝试</li>
  <li>结束遍历后，函数会释放listp占有的内存，并且判断是否获取到能够套接字，如果获取不到则返回-1，反之则尝试调用listen函数，调用成功返回listenfd，反之则返回-1</li>
</ul>

<h4 id="tinyc的main函数">tiny.c的main函数</h4>

<p><strong>具体代码</strong></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> 
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">listenfd</span><span class="p">,</span> <span class="n">connfd</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">hostname</span><span class="p">[</span><span class="n">MAXLINE</span><span class="p">],</span> <span class="n">port</span><span class="p">[</span><span class="n">MAXLINE</span><span class="p">];</span>
    <span class="n">socklen_t</span> <span class="n">clientlen</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="n">clientaddr</span><span class="p">;</span>

    <span class="cm">/* Check command line args */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"usage: %s &lt;port&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">listenfd</span> <span class="o">=</span> <span class="n">Open_listenfd</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">clientlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">clientaddr</span><span class="p">);</span>
	<span class="n">connfd</span> <span class="o">=</span> <span class="n">Accept</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,</span> <span class="p">(</span><span class="n">SA</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">clientaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clientlen</span><span class="p">);</span> <span class="c1">//line:netp:tiny:accept</span>
        <span class="n">Getnameinfo</span><span class="p">((</span><span class="n">SA</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">clientaddr</span><span class="p">,</span> <span class="n">clientlen</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">MAXLINE</span><span class="p">,</span> 
                    <span class="n">port</span><span class="p">,</span> <span class="n">MAXLINE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Accepted connection from (%s, %s)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">doit</span><span class="p">(</span><span class="n">connfd</span><span class="p">);</span>                                             <span class="c1">//line:netp:tiny:doit</span>
	<span class="n">Close</span><span class="p">(</span><span class="n">connfd</span><span class="p">);</span>                                            <span class="c1">//line:netp:tiny:close</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>详细解析</strong></p>

<ul>
  <li>main函数中的argc表示命令行参数的数目，argv表示参数列表。参数数目默认大于等于1，因为至少有一个参数，也就是argv[0]为程序名</li>
  <li>main函数定义完变量之后会判断传入参数是不是为2个，如果不是则输出错误信息并退出。这里需要的两个参数分别为程序名tiny和端口号。这里的fprintf函数的作用是格式化输出到流或文件中，其中第一个参数是文件指针，这里用的是stderr（Linux内核启动时默认打开三个I/O设备文件：标准输入文件stdin，标准输出文件stdout和标准错误输出文件stderr），后面两个参数分别是输出内容和参数列表</li>
  <li>如果参数数目满足要求的话，就可以调用Open_listendfd创建监听描述符</li>
  <li>打开监听套接字后，服务器将会执行典型的无限服务器循环，不断地接受连接请求，执行事务，并关闭连接它的那一端</li>
</ul>

<h4 id="tinyc的doit函数">tiny.c的doit函数</h4>

<p><strong>具体代码</strong></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
 * doit - handle one HTTP request/response transaction
 */</span>
<span class="kt">void</span> <span class="nf">doit</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">)</span> 
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">is_static</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">stat</span> <span class="n">sbuf</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">MAXLINE</span><span class="p">],</span> <span class="n">method</span><span class="p">[</span><span class="n">MAXLINE</span><span class="p">],</span> <span class="n">uri</span><span class="p">[</span><span class="n">MAXLINE</span><span class="p">],</span> <span class="n">version</span><span class="p">[</span><span class="n">MAXLINE</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">filename</span><span class="p">[</span><span class="n">MAXLINE</span><span class="p">],</span> <span class="n">cgiargs</span><span class="p">[</span><span class="n">MAXLINE</span><span class="p">];</span>
    <span class="n">rio_t</span> <span class="n">rio</span><span class="p">;</span>

    <span class="cm">/* Read request line and headers */</span>
    <span class="n">Rio_readinitb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rio</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Rio_readlineb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rio</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">MAXLINE</span><span class="p">))</span>  <span class="c1">//line:netp:doit:readrequest</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
    <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">"%s %s %s"</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>       <span class="c1">//line:netp:doit:parserequest</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="s">"GET"</span><span class="p">))</span> <span class="p">{</span>                     <span class="c1">//line:netp:doit:beginrequesterr</span>
        <span class="n">clienterror</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="s">"501"</span><span class="p">,</span> <span class="s">"Not Implemented"</span><span class="p">,</span>
                    <span class="s">"Tiny does not implement this method"</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>                                                    <span class="c1">//line:netp:doit:endrequesterr</span>
    <span class="n">read_requesthdrs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rio</span><span class="p">);</span>                              <span class="c1">//line:netp:doit:readrequesthdrs</span>

    <span class="cm">/* Parse URI from GET request */</span>
    <span class="n">is_static</span> <span class="o">=</span> <span class="n">parse_uri</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">cgiargs</span><span class="p">);</span>       <span class="c1">//line:netp:doit:staticcheck</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sbuf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>                     <span class="c1">//line:netp:doit:beginnotfound</span>
	<span class="n">clienterror</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="s">"404"</span><span class="p">,</span> <span class="s">"Not found"</span><span class="p">,</span>
		    <span class="s">"Tiny couldn't find this file"</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>                                                    <span class="c1">//line:netp:doit:endnotfound</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">is_static</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Serve static content */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">sbuf</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">S_IRUSR</span> <span class="o">&amp;</span> <span class="n">sbuf</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span> <span class="p">{</span> <span class="c1">//line:netp:doit:readable</span>
	    <span class="n">clienterror</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="s">"403"</span><span class="p">,</span> <span class="s">"Forbidden"</span><span class="p">,</span>
			<span class="s">"Tiny couldn't read the file"</span><span class="p">);</span>
	    <span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">serve_static</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">sbuf</span><span class="p">.</span><span class="n">st_size</span><span class="p">);</span>        <span class="c1">//line:netp:doit:servestatic</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span> <span class="cm">/* Serve dynamic content */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">sbuf</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">S_IXUSR</span> <span class="o">&amp;</span> <span class="n">sbuf</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span> <span class="p">{</span> <span class="c1">//line:netp:doit:executable</span>
	    <span class="n">clienterror</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="s">"403"</span><span class="p">,</span> <span class="s">"Forbidden"</span><span class="p">,</span>
			<span class="s">"Tiny couldn't run the CGI program"</span><span class="p">);</span>
	    <span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">serve_dynamic</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">cgiargs</span><span class="p">);</span>            <span class="c1">//line:netp:doit:servedynamic</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>详细解析</strong></p>

<ul>
  <li>doit函数负责处理HTTP事务，这里需要指出的是，Tiny Web服务器只支持GET方法，不支持POST方法，对于POST请求，会发送一个错误提示并返回程序</li>
  <li>doit函数会首先调用Rio_readinitb函数进行初始化，将socket描述符和读缓存区和重置缓冲区关联起来</li>
  <li>然后读取数据，如果读取失败则返回，成功则利用sscanf函数将buf按照“%s %s %s”的格式分别读取到method、uri和version</li>
  <li>接下来doit函数将判断method是不是get，如果不是则提示错误信息并返回，如果是则调用read_requesthdrs函数读取请求报头信息并进行忽略，因为Tiny并不需要使用到</li>
  <li>接着doit函数将GET请求中的URI解析为一个文件名和一个可能为空的CGI参数字符串，并设置标志is_static标志是静态内容还是动态内容。如果文件不存在，函数将发送错误信息并返回</li>
  <li>如果请求的是静态内容，将验证是否是普通文件且拥有读权限，如果是，则提供静态内容。如果请求的是动态内容，则验证是否为可执行文件，如果是，则继续并提供动态内容</li>
</ul>

<h4 id="tinyc的serve_static函数">tiny.c的serve_static函数</h4>

<p><strong>具体代码</strong></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
 * serve_static - copy a file back to the client 
 */</span>
<span class="kt">void</span> <span class="nf">serve_static</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="kt">int</span> <span class="n">filesize</span><span class="p">)</span> 
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">srcfd</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">srcp</span><span class="p">,</span> <span class="n">filetype</span><span class="p">[</span><span class="n">MAXLINE</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="n">MAXBUF</span><span class="p">];</span>
 
    <span class="cm">/* Send response headers to client */</span>
    <span class="n">get_filetype</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">filetype</span><span class="p">);</span>       <span class="c1">//line:netp:servestatic:getfiletype</span>
    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">"HTTP/1.0 200 OK</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>    <span class="c1">//line:netp:servestatic:beginserve</span>
    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">"%sServer: Tiny Web Server</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">"%sConnection: close</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">"%sContent-length: %d</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">filesize</span><span class="p">);</span>
    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">"%sContent-type: %s</span><span class="se">\r\n\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">filetype</span><span class="p">);</span>
    <span class="n">Rio_writen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>       <span class="c1">//line:netp:servestatic:endserve</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Response headers:</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

    <span class="cm">/* Send response body to client */</span>
    <span class="n">srcfd</span> <span class="o">=</span> <span class="n">Open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>    <span class="c1">//line:netp:servestatic:open</span>
    <span class="n">srcp</span> <span class="o">=</span> <span class="n">Mmap</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">filesize</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="p">,</span> <span class="n">MAP_PRIVATE</span><span class="p">,</span> <span class="n">srcfd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span><span class="c1">//line:netp:servestatic:mmap</span>
    <span class="n">Close</span><span class="p">(</span><span class="n">srcfd</span><span class="p">);</span>                           <span class="c1">//line:netp:servestatic:close</span>
    <span class="n">Rio_writen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">srcp</span><span class="p">,</span> <span class="n">filesize</span><span class="p">);</span>         <span class="c1">//line:netp:servestatic:write</span>
    <span class="n">Munmap</span><span class="p">(</span><span class="n">srcp</span><span class="p">,</span> <span class="n">filesize</span><span class="p">);</span>                 <span class="c1">//line:netp:servestatic:munmap</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>详细解析</strong></p>

<ul>
  <li>TINY提供四种不同类型的静态内容：HTML文件、无格式的文本文件，以及编码为GIF和JPEG格式的图片</li>
  <li>serve_static函数首先判断文件的类型，然后发送响应行和响应报头给客户端。注意用一个空行终止报头</li>
  <li>接着函数以读形式打开请求文件，并获取它的描述符，然后用Mmap函数将被请求文件映射到一个虚拟存储器空间。一旦将文件映射到存储器，我们就可以关闭文件了。最后再用Rio_writen函数将文件传送到客户端并用Munmap函数释放映射的虚拟存储器区域</li>
</ul>

<h4 id="tinyc的serve_dynamic函数">tiny.c的serve_dynamic函数</h4>

<p><strong>具体代码</strong></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
 * serve_dynamic - run a CGI program on behalf of the client
 */</span>
<span class="kt">void</span> <span class="nf">serve_dynamic</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cgiargs</span><span class="p">)</span> 
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">MAXLINE</span><span class="p">],</span> <span class="o">*</span><span class="n">emptylist</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">NULL</span> <span class="p">};</span>

    <span class="cm">/* Return first part of HTTP response */</span>
    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">"HTTP/1.0 200 OK</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span> 
    <span class="n">Rio_writen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">"Server: Tiny Web Server</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">Rio_writen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
  
    <span class="k">if</span> <span class="p">(</span><span class="n">Fork</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Child */</span> <span class="c1">//line:netp:servedynamic:fork</span>
	<span class="cm">/* Real server would set all CGI vars here */</span>
	<span class="n">setenv</span><span class="p">(</span><span class="s">"QUERY_STRING"</span><span class="p">,</span> <span class="n">cgiargs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="c1">//line:netp:servedynamic:setenv</span>
	<span class="n">Dup2</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">STDOUT_FILENO</span><span class="p">);</span>         <span class="cm">/* Redirect stdout to client */</span> <span class="c1">//line:netp:servedynamic:dup2</span>
	<span class="n">Execve</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">emptylist</span><span class="p">,</span> <span class="n">environ</span><span class="p">);</span> <span class="cm">/* Run CGI program */</span> <span class="c1">//line:netp:servedynamic:execve</span>
    <span class="p">}</span>
    <span class="n">Wait</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span> <span class="cm">/* Parent waits for and reaps child */</span> <span class="c1">//line:netp:servedynamic:wait</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>详细解析</strong></p>

<ul>
  <li>Tiny通过派生一个子进程并在子进程的上下文中运行一个CGI程序，来提供各种类型的动态内容</li>
  <li>serve_dynamic函数首先向客户端发送一个表明成功的响应行，同时还包括带有信息的Server报头。CGI程序负责发送响应的剩余部分。注意，这并不像我们可能希望的那样健壮，因为它没有考虑到CGI程序会遇到某些错误的可能性</li>
  <li>serve_dynamic函数会派生一个子进程，用来自请求URI的CGI参数初始化QUERY_STRING环境变量，接着子进程重定向它的标准输出到已连接文件描述符，然后加载并运行CGI程序</li>
  <li>等子进程终止后，父进程会回收操作系统分配给子进程的资源，函数执行结束</li>
</ul>

    </article>
    <div class="share">
      <div class="share-component"></div>
    </div>
    <div class="comment">
      
  
        <div id="container"></div>
        <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
        <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
        <script>
        var gitment = new Gitment({
            id: '/c/c++/2017/03/20/TinyWeb/',
            owner: 'ercong21',
            repo: 'blog-comments',
            oauth: {
                client_id: '5818ceff784afe05d31c',
                client_secret: 'dc7e8efc044c7194cf453740f82c646aa998f206',
            },
        })
        gitment.render('container')
        </script>
  


    </div>
	<ul class="pager">
		
		<li class="previous">
			<a href="/tool/2017/03/19/Tmux/" data-toggle="tooltip" data-placement="top" title="Tmux 终端复用">
				Previous<br>
				<span>Tmux 终端复用</span>
			</a>
		</li>
		
		
		<li class="next">
			<a href="/python/2017/03/21/PythonSimulatePost/" data-toggle="tooltip" data-placement="top" title="Python 历险记第五站——利用 Python 模拟 Post 请求">
				Next<br>
				<span>Python 历险记第五站——利用 Python 模拟 Post 请求</span>
			</a>
		</li>
		
	</ul>
  </div>
  <div class="column one-fourth">
    
<h3>Search</h3>
<div id="site_search">
    <input type="text" id="search_box" placeholder="Search">
</div>

<ul id="search_results"></ul>

<link rel="stylesheet" type="text/css" href="http://localhost:4000/assets/css/modules/sidebar-search.css">
<script src="http://localhost:4000/assets/js/jekyll-search.min.js"></script>
<script src="http://localhost:4000/assets/js/search.js"></script>

<script type="text/javascript">
SimpleJekyllSearch({
    searchInput: document.getElementById('search_box'),
    resultsContainer: document.getElementById('search_results'),
    json: 'http://localhost:4000/assets/search_data.json',
    searchResultTemplate: '<li><a href="{url}" title="{desc}">{title}</a></li>',
    noResultsText: 'No results found',
    limit: 10,
    fuzzy: false,
    exclude: ['Welcome']
})
</script>

    
<h3 class="post-directory-title mobile-hidden">Table of Contents</h3>
<div id="post-directory-module" class="mobile-hidden">
  <section class="post-directory">
  <!-- Links that trigger the jumping -->
  <!-- Added by javascript below -->
  <dl></dl>
  </section>
</div>

<script src="http://localhost:4000/assets/js/jquery.toc.js"></script>

  </div>
</div>
</section>
<!-- /section.content -->

    <footer class="container">
        <div class="site-footer" role="contentinfo">
            <div class="copyright left mobile-block">
                <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a>
            </div>

            <ul class="site-footer-links right mobile-hidden">
                <li>
                    <a href="javascript:window.scrollTo(0,0)" >TOP</a>
                </li>
            </ul>
            <a href="https://github.com/ercong21/ercong21.github.io" target="_blank" aria-label="view source code">
                <span class="mega-octicon octicon-mark-github" title="GitHub"></span>
            </a>
            <ul class="site-footer-links mobile-hidden">
                
                <li>
                    <a href="http://localhost:4000/" title="Home" target="">Home</a>
                </li>
                
                <li>
                    <a href="http://localhost:4000/news/" title="News" target="">News</a>
                </li>
                
                <li>
                    <a href="http://localhost:4000/publications/" title="Publications" target="">Publications</a>
                </li>
                
                <li>
                    <a href="http://localhost:4000/teaching/" title="Teaching" target="">Teaching</a>
                </li>
                
                <li>
                    <a href="http://localhost:4000/grants/" title="Grants" target="">Grants</a>
                </li>
                
                <li>
                    <a href="http://localhost:4000/files/Resume_Nie.pdf" title="CV" target="">CV</a>
                </li>
                
            </ul>

        </div>
    </footer>
    <!-- / footer -->
    <script src="http://localhost:4000/assets/vendor/share.js/dist/js/share.min.js"></script>
    <script src="http://localhost:4000/assets/js/geopattern.js"></script>
    <script src="http://localhost:4000/assets/js/prism.js"></script>
    <link rel="stylesheet" href="http://localhost:4000/assets/css/globals/prism.css">
    <script>
      jQuery(document).ready(function($) {
        // geopattern
        $('.geopattern').each(function(){
          $(this).geopattern($(this).data('pattern-id'));
        });
       // hljs.initHighlightingOnLoad();
      });
    </script>
    
</body>
</html>
